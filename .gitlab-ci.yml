
##########################################################################
# preamble
##########################################################################

stages:
  - build
  - run
  - docker

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_SSL_NO_VERIFY: "true"
  FROM: atlas/analysisbase:21.2.23

##########################################################################
# job defaults

.base: &base
  image: atlas/analysisbase:21.2.23
  tags:
    - k8s

##########################################################################
# job definitions
##########################################################################
# stage: build

compile:
  <<: *base
  stage: build
  script:
    - source /home/atlas/release_setup.sh
    - mkdir build
    - cd build
    - cmake ..
    - make -j4
  artifacts:
    expire_in: 3d
    untracked: true
    paths:
      - build
      - CAFCore/cafsetup.sh

##########################################################################
# stage: run

run_minimal:
  <<: *base
  stage: run
  dependencies:
    - compile
  before_script:
    - pwd
    - mkdir -p ~/.ssh
    - source ~/.bashrc || echo ignore alrb
    - echo "${KRB_PASSWORD}" | kinit ${KRB_USERNAME}@CERN.CH
    - klist
    - echo -e "Host svn.cern.ch lxplus.cern.ch\n\tUser ${CERN_USER}\n\tStrictHostKeyChecking no\n\tGSSAPIAuthentication yes\n\tGSSAPIDelegateCredentials yes\n\tProtocol 2\n\tForwardX11 no\n\tIdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - cat ~/.ssh/config
  script:
    - source /home/atlas/release_setup.sh
    - source setup/setupAnalysis.sh
    - mkdir run
    - cd run
    - prepare.py minimal/config/master/prepare-Minimal-Example.cfg
    - initialize.py minimal/config/master/initialize-Minimal-Example.cfg
    - analyze.py minimal/config/master/analyze-Minimal-Example.cfg
    - visualize.py minimal/config/master/visualize-Minimal-Example.cfg
  artifacts:
    paths:
      - run/sampleFolders
      - run/results
    name: "${CI_JOB_NAME}"
    expire_in: 3 mos

run_flatNTuple:
  <<: *base
  stage: run
  dependencies:
    - compile
  before_script:
    - pwd
    - mkdir -p ~/.ssh
    - source ~/.bashrc || echo ignore alrb
    - echo "${KRB_PASSWORD}" | kinit ${KRB_USERNAME}@CERN.CH
    - klist
    - echo -e "Host svn.cern.ch lxplus.cern.ch\n\tUser ${CERN_USER}\n\tStrictHostKeyChecking no\n\tGSSAPIAuthentication yes\n\tGSSAPIDelegateCredentials yes\n\tProtocol 2\n\tForwardX11 no\n\tIdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - cat ~/.ssh/config
  script:
    - source /home/atlas/release_setup.sh
    - source setup/setupAnalysis.sh
    - mkdir run
    - cd run
    - prepare.py flatNTuple/config/master/prepare-ZjetsFF-Example.cfg
    - initialize.py flatNTuple/config/master/initialize-ZjetsFF-Example.cfg
    - analyze.py flatNTuple/config/master/analyze-ZjetsFF-Example.cfg
    - visualize.py flatNTuple/config/master/visualize-ZjetsFF-Example.cfg
  artifacts:
    paths:
      - run/sampleFolders
      - run/results
    name: "${CI_JOB_NAME}"
    expire_in: 3 mos

##########################################################################
# stage: docker

build_image:
  stage: docker
  tags:
    - docker-image-build
  script:
    - ignore


