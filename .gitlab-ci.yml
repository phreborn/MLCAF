##########################################################################
# preamble
##########################################################################

stages:
  - build
  - run
  - docker

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_SSL_NO_VERIFY: "true"

##########################################################################
# job defaults

.asg: &asg
  image: atlas/analysisbase:21.2.23
  tags:
    - k8s

.asg_setup: &asg_setup
  before_script:
    - if [ -z "$KRB_USERNAME" ]; then exit 0; fi
    - source /home/atlas/release_setup.sh
    - pwd
    - mkdir -p ~/.ssh
    - source ~/.bashrc || echo ignore alrb
    - echo "${KRB_PASSWORD}" | kinit ${KRB_USERNAME}@CERN.CH
    - klist
    - echo -e "Host svn.cern.ch lxplus.cern.ch\n\tUser ${CERN_USER}\n\tStrictHostKeyChecking no\n\tGSSAPIAuthentication yes\n\tGSSAPIDelegateCredentials yes\n\tProtocol 2\n\tForwardX11 no\n\tIdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
    - cat ~/.ssh/config

.minimal_script: &minimal_script
  script:
    - source setup/setupAnalysis.sh
    - mkdir run
    - cd run
    - prepare.py minimal/config/master/prepare-Minimal-Example.cfg
    - initialize.py minimal/config/master/initialize-Minimal-Example.cfg
    - analyze.py minimal/config/master/analyze-Minimal-Example.cfg
    - visualize.py minimal/config/master/visualize-Minimal-Example.cfg

.flatNTuple_script: &flatNTuple_script
  script:
    - source setup/setupAnalysis.sh
    - mkdir run
    - cd run
    - prepare.py flatNTuple/config/master/prepare-flatNTuple-Example.cfg
    - initialize.py flatNTuple/config/master/initialize-flatNTuple-Example.cfg
    - analyze.py flatNTuple/config/master/analyze-flatNTuple-Example.cfg
    - visualize.py flatNTuple/config/master/visualize-flatNTuple-Example.cfg

.standalone: &standalone
  image: rootproject/root-ubuntu16
  tags: 
    - k8s

##########################################################################
# job definitions
##########################################################################
# stage: build

asg_compile:
  <<: *asg
  stage: build
  script:
    - source /home/atlas/release_setup.sh
    - mkdir build
    - cd build
    - cmake ..
    - make -j4
  artifacts:
    expire_in: 3d
    untracked: true
    paths:
      - build
      - CAFCore/cafsetup.sh

standalone_compile:
  <<: *standalone
  stage: build
  script:
    - mkdir build
    - cd build
    - cmake ..
    - make -j4
  artifacts:
    expire_in: 3d
    untracked: true
    paths:
      - build
      - CAFCore/cafsetup.sh

##########################################################################
# stage: run

run_minimal:
  <<: *asg
  <<: *asg_setup
  <<: *minimal_script
  stage: run
  dependencies:
    - asg_compile
  artifacts:
    paths:
      - run/sampleFolders
      - run/results
    name: "${CI_JOB_NAME}"
    expire_in: 3 mos

run_flatNTuple:
  <<: *asg
  <<: *asg_setup
  <<: *flatNTuple_script
  stage: run
  dependencies:
    - asg_compile
  artifacts:
    paths:
      - run/sampleFolders
      - run/results
    name: "${CI_JOB_NAME}"
    expire_in: 3 mos

##########################################################################
# stage: docker

build_image:
  stage: docker
  tags:
    - docker-image-build
  script:
    - ignore


