# -*- mode: tqfolder -*-

################################################################
##
##  FAKE FACTOR WFR
##
#################################################################

$include("bsmtautau_lephad/config-Common/cuts/cuts.def");



@ */CutMaterialCorrection {
    +CutTruth {
        <.cutExpression="{($(isData) || $(isAntiISO)) ? 1 : ($(isInc) ? ([TruthTauSelector] == 30 || [TruthTauSelector] == 20 || [TruthTauSelector] == 5) :
                         (($(isTT) && [TruthTauSelector] == 30) || ($(isTL) && ([TruthTauSelector] == 20 || [TruthTauSelector] == 5)) || ($(isJET) && [TruthTauSelector] == -30)))}",
         .weightExpression="{$(isData) ? 1 : [ScaleFactor]}", .title="Truth">

        +CutLeptonBasic {
            <.cutExpression="lep_0_p4.Pt() > 30 && lep_0_id_medium ==1", .title = "Lepton basic cut">
        
            +CutTauBasic {
                <.cutExpression="tau_0_p4.Pt() > 25 && fabs(tau_0_p4.Eta()) < 2.3 && 
                    (tau_0_n_charged_tracks == 1 || tau_0_n_charged_tracks == 3) && $(TauIDScore) > $(TauIDScoreCut)", 
                    .title="Tau basic cut">
                
                +CutLepTau {
                    <.cutExpression="lephad_dphi>2.4", .title="Lephad dphi">

                    +CutLeptonISO {
                        <.cutExpression="($(isAntiISO) ? $(isFailISO) : $(isPassISO))",
                        .weightExpression="($(isAntiISO) ? $(applyLFF) : 1)", .title="Lepton isolation">
                    } #End: CutLeptonISO
                } #End: CutLepTau
            } #End: CutTauBasic
        } #End: CutLeptonBasic
    } #End: CutTruth
} #End: CutMaterialCorrection



# Divide to OS/SS region
@ */CutLeptonISO {
    +CutOS {
        <.cutExpression="lephad_qxq == -1", .title="OS", regionCharge="OS">
    } #End: CutOS
    
    +CutSS {
        <.cutExpression="lephad_qxq == 1", .title="SS", regionCharge="SS"> 
    } #End: CutSS
} #End: CutLeptonISO



# Divide to Bveto/Btag region
@ */CutLeptonISO/Cut*S {
    +Cut$(regionCharge)Bveto {
        <.cutExpression="$(NbJets)==0", .title="$(regionCharge)Bveto", regionNbjets="Bveto">
    } #End: Cut[OS/SS]Bveto

    +Cut$(regionCharge)Btag {
        <.cutExpression="$(NbJets)>=1", .title="$(regionCharge)Btag", regionNbjets="Btag",
        .weightExpression="{($(isTop) && $(UseTopSF) && ! ($(isAntiISO) || $(isAntiID))) ? [TopReweight] : 1}">
    } #End: Cut[OS/SS]Btag
} #End: CutLeptonISO/Cut[OS/SS]



# Divide to different MT region
@ */CutLeptonISO/Cut*S/Cut*B* {
    +Cut$(regionCharge)$(regionNbjets)WFR {
        <.cutExpression="lephad_mt_lep0_met >= 60 && ($(NbJets) == 0 ? lephad_mt_lep0_met < 150 : lephad_mt_lep0_met < 110)", 
        .title="$(regionCharge)$(regionNbjets)WFR", regionMT="WFR">
    
        # only apply Zee veto in B-veto category    
        +Cut$(regionCharge)$(regionNbjets)WFRZeeVeto {
            <.cutExpression="(lep_0 == 2 && $(NbJets) == 0)  ? ((lephad_p4.M() > 110 || lephad_p4.M() < 80) ? 1 : 0) : 1", 
             .title="$(regionCharge)$(regionNbjets)VisMassVeto"> 
        }
    } 
}

@ */CutLeptonISO/CutOS/Cut*Btag {
    +Cut$(regionCharge)$(regionNbjets)TCR {
        <.cutExpression="lephad_mt_lep0_met >= 110", 
        .title="$(regionCharge)$(regionNbjets)TCR", regionMT="TCR">
    } 
}



# Divide to 1p/3p region
@ */Cut*ZeeVeto {
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)1p {
        <.cutExpression="tau_0_n_charged_tracks == 1", .title="$(regionCharge)$(regionNbjets)$(regionMT)1p", regionProng="1p">
    }
    
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)3p {
        <.cutExpression="tau_0_n_charged_tracks == 3", .title="$(regionCharge)$(regionNbjets)$(regionMT)3p", regionProng="3p">
    }
}

@ */Cut*Btag/Cut*TCR {
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)1p {
        <.cutExpression="tau_0_n_charged_tracks == 1", .title="$(regionCharge)$(regionNbjets)$(regionMT)1p", regionProng="1p">
    }
    
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)3p {
        <.cutExpression="tau_0_n_charged_tracks == 3", .title="$(regionCharge)$(regionNbjets)$(regionMT)3p", regionProng="3p">
    }
}



# Divide to PassID/FailID region
@ */Cut*p {
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)$(regionProng)PassTauID {
        <.cutExpression="$(isAntiID) ? $(isFailID) : $(isPassID)", 
         .weightExpression="$(isAntiID) ? $(applyWFF) : 1",
         .title="$(regionCharge)$(regionNbjets)$(regionMT)$(regionProng)PassTauID">
    }
    
    +Cut$(regionCharge)$(regionNbjets)$(regionMT)$(regionProng)FailTauID {
        <.cutExpression="$(isAntiID) ? $(isPassID) : $(isFailID)", 
         .weightExpression="$(isAntiID) ? 1 / $(applyWFF) : 1",
         .title="$(regionCharge)$(regionNbjets)$(regionMT)$(regionProng)FailTauID">
    }
}



$replace("*/CutOS/*:*", regionCharge="OS");
$replace("*/CutSS/*:*", regionCharge="SS");
$replace("*/Cut*SBveto/*:*", regionNbjets="Bveto");
$replace("*/Cut*SBtag/*:*", regionNbjets="Btag");
$replace("*/Cut*WFR/*:*", regionMT="WFR");
$replace("*/Cut*TCR/*:*", regionMT="TCR");
$replace("*/Cut*1p/*:*", regionProng="1p");
$replace("*/Cut*3p/*:*", regionProng="3p");
